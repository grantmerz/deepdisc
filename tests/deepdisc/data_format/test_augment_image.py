"""Utilities for augmenting image data."""

import numpy as np
import pytest
from deepdisc.data_format.augment_image import (redden,
                                                gaussblur,
                                                multiband_gaussblur)


@pytest.fixture
def simple_image():
    input_image = np.arange(0,100).reshape(10,10)
    input_image = np.stack([input_image]*6,axis=-1)
    return input_image


def test_redden(simple_image):
    output = redden(simple_image,rng_seed=np.random.default_rng(54622))
    assert len(output) == len(simple_image)
    expected = np.array([[[ 0.        ,  0.        ,  0.        ,  0.        ,
          0.        ,  0.        ],
        [ 0.9251374 ,  0.9428147 ,  0.9572614 ,  0.9672238 ,
          0.9747637 ,  0.97903067],
        [ 1.8502748 ,  1.8856294 ,  1.9145228 ,  1.9344476 ,
          1.9495274 ,  1.9580613 ],
        [ 2.7754123 ,  2.828444  ,  2.871784  ,  2.9016716 ,
          2.9242911 ,  2.937092  ],
        [ 3.7005496 ,  3.7712588 ,  3.8290455 ,  3.8688953 ,
          3.8990548 ,  3.9161227 ],
        [ 4.625687  ,  4.7140737 ,  4.786307  ,  4.836119  ,
          4.8738184 ,  4.8951535 ],
        [ 5.5508246 ,  5.656888  ,  5.743568  ,  5.8033433 ,
          5.8485823 ,  5.874184  ],
        [ 6.4759617 ,  6.599703  ,  6.7008295 ,  6.770567  ,
          6.8233457 ,  6.8532147 ],
        [ 7.401099  ,  7.5425177 ,  7.658091  ,  7.7377906 ,
          7.7981095 ,  7.8322453 ],
        [ 8.326237  ,  8.4853325 ,  8.615353  ,  8.705014  ,
          8.772873  ,  8.811276  ]],

       [[ 9.251374  ,  9.428147  ,  9.572614  ,  9.672238  ,
          9.747637  ,  9.790307  ],
        [10.176512  , 10.370962  , 10.529875  , 10.639462  ,
         10.722401  , 10.769338  ],
        [11.101649  , 11.313776  , 11.487136  , 11.606687  ,
         11.697165  , 11.748368  ],
        [12.026786  , 12.256591  , 12.444398  , 12.57391   ,
         12.671928  , 12.727399  ],
        [12.951923  , 13.199406  , 13.401659  , 13.541134  ,
         13.646691  , 13.7064295 ],
        [13.877061  , 14.1422205 , 14.35892   , 14.508358  ,
         14.621455  , 14.68546   ],
        [14.802198  , 15.085035  , 15.316182  , 15.475581  ,
         15.596219  , 15.664491  ],
        [15.727336  , 16.02785   , 16.273443  , 16.442806  ,
         16.570982  , 16.64352   ],
        [16.652473  , 16.970665  , 17.230705  , 17.410028  ,
         17.545746  , 17.622553  ],
        [17.57761   , 17.913479  , 18.187965  , 18.377253  ,
         18.52051   , 18.601583  ]],

       [[18.502748  , 18.856295  , 19.145227  , 19.344477  ,
         19.495274  , 19.580614  ],
        [19.427885  , 19.799109  , 20.10249   , 20.3117    ,
         20.470037  , 20.559645  ],
        [20.353024  , 20.741924  , 21.05975   , 21.278925  ,
         21.444801  , 21.538675  ],
        [21.27816   , 21.684738  , 22.017012  , 22.24615   ,
         22.419565  , 22.517706  ],
        [22.203299  , 22.627552  , 22.974272  , 23.213373  ,
         23.39433   , 23.496737  ],
        [23.128435  , 23.570368  , 23.931534  , 24.180595  ,
         24.369093  , 24.475767  ],
        [24.053572  , 24.513182  , 24.888796  , 25.14782   ,
         25.343857  , 25.454798  ],
        [24.97871   , 25.455997  , 25.846056  , 26.115044  ,
         26.31862   , 26.433828  ],
        [25.903847  , 26.398811  , 26.803318  , 27.082268  ,
         27.293383  , 27.412859  ],
        [26.828985  , 27.341627  , 27.76058   , 28.049492  ,
         28.268147  , 28.39189   ]],

       [[27.754122  , 28.284441  , 28.71784   , 29.016716  ,
         29.24291   , 29.37092   ],
        [28.67926   , 29.227255  , 29.675102  , 29.98394   ,
         30.217674  , 30.34995   ],
        [29.604397  , 30.17007   , 30.632364  , 30.951162  ,
         31.192438  , 31.328981  ],
        [30.529535  , 31.112885  , 31.589624  , 31.918386  ,
         32.167202  , 32.30801   ],
        [31.454672  , 32.0557    , 32.546886  , 32.885612  ,
         33.141964  , 33.28704   ],
        [32.37981   , 32.998516  , 33.504147  , 33.852837  ,
         34.11673   , 34.266075  ],
        [33.304947  , 33.94133   , 34.46141   , 34.820057  ,
         35.09149   , 35.245106  ],
        [34.230083  , 34.884144  , 35.41867   , 35.78728   ,
         36.066257  , 36.224136  ],
        [35.15522   , 35.826958  , 36.37593   , 36.754505  ,
         37.04102   , 37.203167  ],
        [36.08036   , 36.76977   , 37.333195  , 37.72173   ,
         38.015785  , 38.182198  ]],

       [[37.005497  , 37.71259   , 38.290455  , 38.688953  ,
         38.990547  , 39.16123   ],
        [37.930634  , 38.655403  , 39.247715  , 39.656178  ,
         39.965313  , 40.14026   ],
        [38.85577   , 39.598217  , 40.20498   , 40.6234    ,
         40.940075  , 41.11929   ],
        [39.780907  , 40.54103   , 41.16224   , 41.590626  ,
         41.91484   , 42.09832   ],
        [40.706047  , 41.48385   , 42.1195    , 42.55785   ,
         42.889603  , 43.07735   ],
        [41.631184  , 42.426662  , 43.076763  , 43.525074  ,
         43.864365  , 44.05638   ],
        [42.55632   , 43.369476  , 44.034023  , 44.4923    ,
         44.83913   , 45.03541   ],
        [43.481457  , 44.31229   , 44.991283  , 45.459522  ,
         45.813892  , 46.014442  ],
        [44.406597  , 45.255104  , 45.948544  , 46.426746  ,
         46.78866   , 46.993473  ],
        [45.331734  , 46.19792   , 46.905807  , 47.39397   ,
         47.76342   , 47.972504  ]],

       [[46.25687   , 47.140736  , 47.863068  , 48.36119   ,
         48.738186  , 48.951534  ],
        [47.182007  , 48.08355   , 48.820328  , 49.328415  ,
         49.712948  , 49.930565  ],
        [48.107143  , 49.026363  , 49.77759   , 50.29564   ,
         50.687714  , 50.909595  ],
        [49.032284  , 49.969177  , 50.73485   , 51.262863  ,
         51.662476  , 51.888626  ],
        [49.95742   , 50.911995  , 51.692112  , 52.230087  ,
         52.63724   , 52.867657  ],
        [50.882557  , 51.85481   , 52.649376  , 53.19731   ,
         53.612003  , 53.846687  ],
        [51.807693  , 52.797623  , 53.606636  , 54.164536  ,
         54.586765  , 54.825718  ],
        [52.732834  , 53.740437  , 54.563896  , 55.13176   ,
         55.56153   , 55.80475   ],
        [53.65797   , 54.683254  , 55.52116   , 56.098984  ,
         56.536293  , 56.78378   ],
        [54.583107  , 55.62607   , 56.47842   , 57.066208  ,
         57.51106   , 57.76281   ]],

       [[55.508244  , 56.568882  , 57.43568   , 58.033432  ,
         58.48582   , 58.74184   ],
        [56.43338   , 57.511696  , 58.392944  , 59.000656  ,
         59.460587  , 59.72087   ],
        [57.35852   , 58.45451   , 59.350204  , 59.96788   ,
         60.43535   , 60.6999    ],
        [58.283657  , 59.397327  , 60.307465  , 60.935104  ,
         61.410114  , 61.678932  ],
        [59.208794  , 60.34014   , 61.26473   , 61.902325  ,
         62.384876  , 62.657963  ],
        [60.13393   , 61.282955  , 62.22199   , 62.86955   ,
         63.359642  , 63.636993  ],
        [61.05907   , 62.22577   , 63.17925   , 63.836773  ,
         64.334404  , 64.61602   ],
        [61.984207  , 63.168587  , 64.13651   , 64.804     ,
         65.309166  , 65.595055  ],
        [62.909344  , 64.1114    , 65.09377   , 65.771225  ,
         66.28393   , 66.57408   ],
        [63.83448   , 65.054214  , 66.05103   , 66.73845   ,
         67.2587    , 67.553116  ]],

       [[64.75962   , 65.99703   , 67.00829   , 67.70567   ,
         68.23346   , 68.53215   ],
        [65.68475   , 66.93984   , 67.96555   , 68.67289   ,
         69.20822   , 69.51118   ],
        [66.60989   , 67.88266   , 68.92282   , 69.640114  ,
         70.18298   , 70.49021   ],
        [67.535034  , 68.82547   , 69.88008   , 70.60734   ,
         71.15775   , 71.46924   ],
        [68.46017   , 69.76829   , 70.83734   , 71.57456   ,
         72.132515  , 72.44827   ],
        [69.38531   , 70.711105  , 71.7946    , 72.54179   ,
         73.10728   , 73.4273    ],
        [70.31044   , 71.653915  , 72.75186   , 73.50901   ,
         74.08204   , 74.406334  ],
        [71.23558   , 72.59673   , 73.70912   , 74.476234  ,
         75.05681   , 75.38536   ],
        [72.16072   , 73.53954   , 74.66639   , 75.44346   ,
         76.03157   , 76.364395  ],
        [73.08585   , 74.48236   , 75.62365   , 76.41068   ,
         77.00633   , 77.34342   ]],

       [[74.010994  , 75.42518   , 76.58091   , 77.37791   ,
         77.981094  , 78.32246   ],
        [74.93613   , 76.36799   , 77.53817   , 78.34513   ,
         78.95586   , 79.30148   ],
        [75.86127   , 77.31081   , 78.49543   , 79.312355  ,
         79.930626  , 80.28052   ],
        [76.78641   , 78.25362   , 79.45269   , 80.27958   ,
         80.90539   , 81.259544  ],
        [77.71154   , 79.196434  , 80.40996   , 81.2468    ,
         81.88015   , 82.23858   ],
        [78.63668   , 80.13925   , 81.36722   , 82.21403   ,
         82.85491   , 83.217606  ],
        [79.56181   , 81.08206   , 82.32448   , 83.18125   ,
         83.82968   , 84.19664   ],
        [80.48695   , 82.02488   , 83.28174   , 84.148476  ,
         84.80444   , 85.17567   ],
        [81.412094  , 82.9677    , 84.239     , 85.1157    ,
         85.779205  , 86.1547    ],
        [82.33723   , 83.91051   , 85.19626   , 86.082924  ,
         86.75397   , 87.13373   ]],

       [[83.26237   , 84.853325  , 86.15353   , 87.05015   ,
         87.72873   , 88.11276   ],
        [84.18751   , 85.796135  , 87.11079   , 88.01737   ,
         88.7035    , 89.09179   ],
        [85.11264   , 86.73895   , 88.06805   , 88.9846    ,
         89.67826   , 90.07082   ],
        [86.03778   , 87.68177   , 89.02531   , 89.95182   ,
         90.65302   , 91.04985   ],
        [86.96291   , 88.62458   , 89.98257   , 90.919044  ,
         91.627785  , 92.028885  ],
        [87.888054  , 89.5674    , 90.93983   , 91.88627   ,
         92.602554  , 93.00791   ],
        [88.813194  , 90.51021   , 91.89709   , 92.85349   ,
         93.57732   , 93.986946  ],
        [89.73833   , 91.453026  , 92.854355  , 93.82072   ,
         94.55208   , 94.96597   ],
        [90.66347   , 92.39584   , 93.811615  , 94.78794   ,
         95.52684   , 95.94501   ],
        [91.5886    , 93.33865   , 94.768875  , 95.75516   ,
         96.50161   , 96.924034  ]]])

    assert np.all(output == expected)


def test_gaussblur(simple_image):
    output = gaussblur(simple_image, rng_seed=np.random.default_rng(54622))
    assert len(output) == len(simple_image)
    expected = np.stack(np.array([ 
       [ 0,  1,  2,  3,  4,  5,  6,  7,  8,  8],
       [10, 11, 12, 13, 14, 15, 16, 17, 18, 18],
       [20, 21, 22, 23, 24, 25, 26, 27, 28, 28],
       [30, 31, 32, 33, 34, 35, 36, 37, 38, 38],
       [40, 41, 42, 43, 44, 45, 46, 47, 48, 48],
       [50, 51, 52, 53, 54, 55, 56, 57, 58, 58],
       [60, 61, 62, 63, 64, 65, 66, 67, 68, 68],
       [70, 71, 72, 73, 74, 75, 76, 77, 78, 78],
       [80, 81, 82, 83, 84, 85, 86, 87, 88, 88],
       [89, 90, 91, 92, 93, 94, 95, 96, 97, 97]
    ]*6,axis=-1))
    assert np.all(output == expected)


def test_multiband_gaussblur(simple_image):
    output = multiband_gaussblur(simple_image, rng_seed=np.random.default_rng(54622))
    assert len(output) == len(simple_image)
    arr1 = np.array([[ 6,  7,  8,  9, 10, 11, 11, 12, 13, 14],
       [10, 11, 12, 13, 14, 15, 15, 16, 17, 18],
       [20, 21, 22, 23, 24, 25, 25, 26, 27, 28],
       [30, 31, 32, 33, 34, 35, 35, 36, 37, 38],
       [40, 41, 42, 43, 44, 45, 45, 46, 47, 48],
       [50, 51, 52, 53, 54, 55, 55, 56, 57, 58],
       [59, 60, 61, 62, 63, 64, 64, 65, 66, 67],
       [69, 70, 71, 72, 73, 74, 74, 75, 76, 77],
       [79, 80, 81, 82, 83, 84, 84, 85, 86, 87],
       [83, 84, 85, 86, 87, 88, 88, 89, 90, 91]])
    arr2 = np.array([[ 5,  6,  7,  7,  8,  9, 10, 11, 12, 13],
       [10, 11, 12, 12, 13, 14, 15, 16, 17, 18],
       [20, 21, 22, 22, 24, 25, 25, 26, 27, 28],
       [29, 30, 31, 32, 33, 34, 35, 35, 36, 37],
       [39, 40, 41, 42, 43, 44, 45, 46, 47, 48],
       [50, 50, 51, 52, 52, 53, 54, 55, 56, 57],
       [60, 60, 61, 62, 63, 64, 65, 66, 67, 67],
       [69, 70, 71, 71, 73, 73, 75, 75, 76, 77],
       [79, 80, 81, 81, 82, 83, 84, 85, 86, 87],
       [84, 85, 86, 87, 87, 89, 90, 90, 91, 92]])
    arr3 = np.array([[ 5,  6,  7,  8,  9, 10, 11, 11, 12, 13],
       [10, 11, 12, 13, 14, 15, 16, 16, 17, 18],
       [20, 21, 22, 23, 24, 25, 26, 26, 27, 28],
       [30, 31, 32, 33, 34, 35, 36, 36, 37, 38],
       [40, 41, 42, 43, 44, 45, 46, 46, 47, 48],
       [50, 51, 52, 53, 54, 55, 56, 56, 57, 58],
       [60, 61, 62, 63, 64, 65, 66, 66, 67, 68],
       [69, 70, 71, 72, 73, 74, 75, 75, 76, 77],
       [79, 80, 81, 82, 83, 84, 85, 85, 86, 87],
       [84, 85, 86, 87, 88, 89, 90, 90, 91, 92]])
    arr4 = np.array([[ 5,  6,  7,  7,  8, 10, 10, 11, 12, 13],
       [10, 11, 12, 12, 13, 14, 15, 16, 17, 18],
       [20, 21, 22, 22, 23, 24, 25, 26, 27, 28],
       [29, 30, 31, 31, 32, 33, 35, 36, 37, 37],
       [40, 40, 41, 42, 43, 44, 45, 46, 46, 47],
       [49, 50, 51, 52, 53, 53, 54, 55, 56, 57],
       [59, 60, 61, 62, 63, 64, 65, 66, 67, 67],
       [69, 70, 71, 71, 72, 73, 75, 75, 76, 77],
       [79, 80, 81, 81, 82, 84, 84, 85, 86, 87],
       [84, 85, 86, 87, 87, 88, 90, 90, 91, 92]])
    arr5 = np.array([[ 5,  6,  7,  7,  9, 10, 11, 11, 12, 13],
       [10, 11, 12, 13, 14, 15, 15, 16, 17, 18],
       [20, 21, 22, 23, 24, 25, 26, 26, 27, 28],
       [30, 30, 31, 32, 33, 34, 36, 36, 37, 38],
       [40, 41, 42, 43, 44, 45, 46, 46, 47, 48],
       [50, 51, 52, 53, 54, 55, 56, 56, 57, 58],
       [60, 61, 61, 62, 63, 64, 65, 66, 67, 68],
       [69, 70, 71, 72, 73, 74, 75, 75, 76, 77],
       [79, 80, 81, 82, 83, 84, 85, 85, 86, 87],
       [84, 85, 86, 87, 88, 89, 90, 90, 91, 92]])
    arr6 = np.array([[ 4,  5,  6,  7,  8,  9, 10, 10, 11, 12],
       [10, 11, 12, 13, 14, 15, 16, 16, 17, 18],
       [20, 21, 22, 23, 24, 25, 26, 26, 27, 28],
       [30, 31, 32, 33, 34, 35, 36, 36, 37, 38],
       [40, 41, 42, 43, 44, 45, 46, 46, 47, 48],
       [50, 51, 52, 53, 54, 55, 56, 56, 57, 58],
       [60, 61, 62, 63, 64, 65, 66, 66, 67, 68],
       [69, 70, 71, 72, 73, 74, 75, 75, 76, 77],
       [79, 80, 81, 82, 83, 84, 85, 85, 86, 87],
       [85, 86, 87, 88, 89, 90, 91, 91, 92, 93]])
    
    expected = np.stack([arr1,arr2,arr3,arr4,arr5,arr6],axis=-1)
    assert np.all(output == expected)


